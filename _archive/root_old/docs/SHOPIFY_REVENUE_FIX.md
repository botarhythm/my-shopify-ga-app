# Shopify売上集計の重複カウント問題修正

## 概要

Shopifyの売上集計に重複カウントなどの重大な誤りが発見され、修正しました。修正前は¥1,774,281でしたが、修正後は¥732,845となり、Shopifyの実際の売上¥747,518に非常に近い値になりました。

## 問題の詳細

### 発見された問題
1. **ラインアイテムレベルの価格計算エラー**
   - `total_price`フィールドに注文全体の金額を設定していた
   - 各ラインアイテムが同じ金額（注文合計）を持っていた
   - 結果として売上が重複カウントされていた

### 修正前の状況
- **2025年1月1日〜9月11日のShopify売上**: ¥1,774,281
- **Shopifyの実際の売上**: ¥747,518
- **差**: 約2.4倍の過大評価

### 修正後の状況
- **2025年1月1日〜9月11日のShopify売上**: ¥732,845（返金考慮後）
- **Shopifyの実際の売上**: ¥747,518
- **差**: 約¥14,000（1.9%の差）

## 修正内容

### 1. Shopifyコネクタの修正

#### 修正前
```python
"total_price": _get_amount(order, "current_total_price", "total_price"),
```

#### 修正後
```python
# 修正: total_priceはラインアイテムの個別金額（単価×数量）
"total_price": float(line_item.get("price", 0)) * float(line_item.get("quantity", 0)),
```

### 2. 影響を受けた関数
- `fetch_orders_incremental()`
- `fetch_orders_by_processed_range()`
- `fetch_orders_by_paid_range()`

### 3. データベースの再構築
- 既存のデータベースをバックアップ
- 修正されたコネクタでデータを再取得
- スキーマの再初期化

## 修正結果の詳細

### データの整合性確認

#### 注文数
- **総注文数**: 147件（Shopifyの150件に近い）
- **支払済み注文**: 144件
- **一部返金済み注文**: 3件

#### 売上金額
- **総売上**: ¥734,380
- **総返金額**: ¥1,535
- **正味売上**: ¥732,845

#### 月別売上（2025年）
```
2025-01: 15件, ¥66,880
2025-02: 19件, ¥100,100
2025-03: 25件, ¥128,470
2025-04: 21件, ¥106,890
2025-05: 13件, ¥69,940
2025-06: 13件, ¥71,350
2025-07: 19件, ¥96,190
2025-08: 15件, ¥65,160
2025-09: 4件, ¥14,400
```

### 残存する差の要因

約¥14,000の差は以下の要因によるものと考えられます：

1. **期間の違い**
   - データが9月9日で止まっている
   - 9月10日〜11日のデータがない

2. **Shopifyの計算方法**
   - 送料、税金、手数料の扱いの違い
   - 返金処理のタイミングの違い

3. **データ取得のタイミング**
   - APIとダッシュボードの更新タイミングの違い

## 技術的改善点

### 1. データ構造の正規化
- ラインアイテムレベルの正確な価格計算
- 注文レベルの合計金額との整合性確保

### 2. エラーハンドリングの改善
- 価格計算の例外処理
- データ型の適切な変換

### 3. データ検証の強化
- 重複レコードの検出
- 価格計算の妥当性チェック

## 今後の対策

### 1. データ品質監視
- 定期的な売上データの整合性チェック
- Shopifyの実際の売上との比較

### 2. エラー検出の自動化
- 異常な価格パターンの検出
- 重複データの自動検出

### 3. データ更新の最適化
- より頻繁なデータ更新
- リアルタイムデータ同期の検討

## アクセス方法

**URL**: http://localhost:8505

## 確認方法

### 1. ダッシュボードでの確認
- 月別売上データの表示
- YoY成長率の正確性
- 注文数の整合性

### 2. データベースでの確認
```sql
-- 2025年1月1日〜9月11日のShopify売上
SELECT 
    COUNT(DISTINCT order_id) as orders,
    SUM(total_price) as revenue
FROM core_shopify 
WHERE financial_status = 'paid'
AND date >= '2025-01-01'
AND date <= '2025-09-11';
```

## まとめ

Shopifyの売上集計の重複カウント問題を根本的に修正し、実際の売上に非常に近い値（誤差1.9%）を実現しました。これにより、ダッシュボードの売上データが正確で信頼性の高いものになりました。

### 修正前後の比較
| 項目 | 修正前 | 修正後 | 改善率 |
|------|--------|--------|--------|
| 売上金額 | ¥1,774,281 | ¥732,845 | 58.7%削減 |
| Shopifyとの差 | 137.4% | 1.9% | 98.6%改善 |
| データの信頼性 | 低 | 高 | 大幅改善 |
